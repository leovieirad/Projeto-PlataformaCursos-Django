{% extends 'base.html' %}

{% block title %}{{ curso.titulo }}{% endblock %}

{% block content %}
<h2>{{ curso.titulo }}</h2>
<p>{{ curso.descricao }}</p>

{% if curso.imagem %}
  <img src="{{ curso.imagem.url }}" class="img-fluid mb-3" alt="Imagem do curso">
{% endif %}

{% if user.is_authenticated %}
  {% if not esta_matriculado %}
    <form method="post" action="{% url 'matricular_curso' curso.slug %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-success">Matricular-se neste curso</button>
    </form>
  {% else %}
    <form method="post" action="{% url 'desmatricular_curso' curso.slug %}" class="mt-3">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">Desmatricular-se do curso</button>
    </form>
  {% endif %}
{% else %}
  <div class="alert alert-warning">Faça login para se matricular neste curso.</div>
{% endif %}

{% if user.is_authenticated and esta_matriculado %}
  <div class="mb-4">
    <p>
      <strong>Progresso:</strong>
      <span id="texto-progresso">{{ progresso_percentual }}%</span>
      ({{ aulas_assistidas|length }} de {{ aulas|length }} aulas assistidas)
    </p>
    <div style="height: 20px; background: #e0e0e0; border-radius: 10px;">
      <div id="barra-progresso"
           style="width: {{ progresso_percentual }}%; background: #4CAF50; height: 100%; border-radius: 10px;">
      </div>
    </div>
  </div>

  {% if aula_atual %}
    <hr>
    <h4>{{ aula_atual.titulo }}</h4>

    {% if aula_atual.video_url %}
      <div class="ratio ratio-16x9 mb-3">
        <iframe src="{{ aula_atual.video_url }}" frameborder="0" allowfullscreen></iframe>
      </div>
    {% endif %}

    {% if aula_atual.conteudo %}
      <div class="mb-3">{{ aula_atual.conteudo|safe }}</div>
    {% endif %}
  {% endif %}

  <hr>
  <h4>Conteúdo do Curso</h4>
  <ul class="list-group">
    {% for aula in aulas %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <a href="?aula={{ aula.id }}">{{ aula.titulo }}</a>
        <input type="checkbox"
               class="form-check-input marcar-aula"
               data-aula-id="{{ aula.id }}"
               {% if aula.id in aulas_assistidas_ids %}checked{% endif %}>
      </li>
    {% endfor %}
  </ul>

  <hr>
  <h4>Deixe seu comentário</h4>
  <form method="post" action="{% url 'comentar_curso' curso.slug %}">
    {% csrf_token %}
    <div class="mb-3">
      {{ form_comentario.texto }}
    </div>
    <button type="submit" class="btn btn-primary">Enviar comentário</button>
  </form>

  <hr>
  <h4>Comentários</h4>
  {% if comentarios %}
    {% for comentario in comentarios %}
      <div class="card my-3">
        <div class="card-body">
          <strong>{{ comentario.usuario.username }}</strong>
          <span class="text-muted" style="font-size: 0.9em;">
            em {{ comentario.criado_em|date:"d/m/Y H:i" }}
          </span>
          <p>{{ comentario.texto }}</p>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>Este curso ainda não possui comentários.</p>
  {% endif %}
{% endif %}

<a href="/" class="btn btn-link mt-3">← Voltar para os cursos</a>
{% endblock %}

{% block extra_scripts %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Cookie inicia com o nome desejado?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

document.querySelectorAll('.marcar-aula').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
        fetch(`/aula/${this.dataset.aulaId}/toggle_assistida/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ assistida: this.checked }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.progresso !== undefined) {
                document.getElementById('barra-progresso').style.width = `${data.progresso}%`;
                document.getElementById('texto-progresso').innerText = `${data.progresso}%`;
            } else {
                alert('Erro ao atualizar progresso!');
            }
        });
    });
});
</script>
{% endblock %}
