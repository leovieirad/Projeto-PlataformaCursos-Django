{% extends 'base.html' %}

{% block title %}{{ curso.titulo }}{% endblock %}

{% block content %}
<h2>{{ curso.titulo }}</h2>
<p>{{ curso.descricao }}</p>

{% if curso.imagem %}
    <img src="{{ curso.imagem.url }}" class="img-fluid mb-3" alt="Imagem do curso">
{% endif %}

{% if user.is_authenticated %}
    {% if not esta_matriculado %}
        <form method="post" action="{% url 'matricular_curso' curso.slug %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">Matricular-se neste curso</button>
        </form>
    {% else %}
        <form method="post" action="{% url 'desmatricular_curso' curso.slug %}" class="mt-3">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Desmatricular-se do curso</button>
        </form>
    {% endif %}
{% else %}
    <div class="alert alert-warning">Faça login para se matricular neste curso.</div>
{% endif %}

{% if user.is_authenticated and esta_matriculado %}
    <div class="mb-4">
        <p><strong>Progresso:</strong> {{ aulas_assistidas }} de {{ total_aulas }} aulas assistidas ({{ progresso_percentual }}%)</p>
        <div style="height: 20px; background: #e0e0e0; border-radius: 10px;">
            <div style="width: {{ progresso_percentual }}%; background: #4CAF50; height: 100%; border-radius: 10px;"></div>
        </div>
    </div>
{% endif %}

<h4>Aulas:</h4>
<ul class="list-group">
    {% for aula in aulas %}
        <li class="list-group-item">
            <strong>{{ aula.titulo }}</strong><br>

            {% if aula.video_url %}
                <div class="ratio ratio-16x9 my-2">
                    <iframe src="{{ aula.video_url|safe }}" frameborder="0" allowfullscreen></iframe>
                </div>
            {% endif %}

            {% if aula.conteudo %}
                <p>{{ aula.conteudo }}</p>
            {% endif %}

            {% if user.is_authenticated %}
                {% if aula.id in aulas_assistidas_ids %}
                    <form action="{% url 'desmarcar_aula_assistida' aula.id %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning btn-sm">Desmarcar como assistida</button>
                    </form>
                {% else %}
                    <form action="{% url 'marcar_aula_assistida' aula.id %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-primary btn-sm">Marcar como assistida</button>
                    </form>
                {% endif %}
            {% endif %}
        </li>
    {% endfor %}
</ul>

<a href="/" class="btn btn-link mt-3">← Voltar para os cursos</a>
{% endblock %}
