{% extends 'base.html' %}

{% block title %}{{ curso.titulo }}{% endblock %}

{% block content %}
<h2>{{ curso.titulo }}</h2>
<p>{{ curso.descricao }}</p>

{% if curso.imagem %}
  <img src="{{ curso.imagem.url }}" class="img-fluid mb-3" alt="Imagem do curso">
{% endif %}

{% if user.is_authenticated %}
  {% if not esta_matriculado %}
    <form method="post" action="{% url 'matricular_curso' curso.slug %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-success">Matricular-se neste curso</button>
    </form>
  {% else %}
    <form method="post" action="{% url 'desmatricular_curso' curso.slug %}" class="mt-3">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">Desmatricular-se do curso</button>
    </form>
  {% endif %}
{% else %}
  <div class="alert alert-warning">Faça login para se matricular neste curso.</div>
{% endif %}

{% if user.is_authenticated and esta_matriculado %}
  <div class="mb-4">
    <p>
      <strong>Progresso:</strong> {{ aulas_assistidas_ids|length }} de {{ aulas|length }} aulas assistidas ({{ progresso_percentual }}%)
    </p>
    <div style="height: 20px; background: #e0e0e0; border-radius: 10px;">
      <div style="width: {{ progresso_percentual }}%; background: #4CAF50; height: 100%; border-radius: 10px;"></div>
    </div>
  </div>

  {% if aula_atual %}
    <hr>
    <h4>{{ aula_atual.titulo }}</h4>

    {% if aula_atual.video_url %}
      <div class="ratio ratio-16x9 mb-3">
        <iframe src="{{ aula_atual.video_url }}" frameborder="0" allowfullscreen></iframe>
      </div>
    {% endif %}

    {% if aula_atual.conteudo %}
      <div class="mb-3">{{ aula_atual.conteudo|safe }}</div>
    {% endif %}
  {% endif %}

  <hr>
  <h4>Conteúdo do Curso</h4>
  <ul class="list-group">
    {% for aula in aulas %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <a href="?aula={{ aula.id }}">{{ aula.titulo }}</a>

        {% if aula.id in aulas_assistidas_ids %}
          <form method="post" action="{% url 'desmarcar_aula' aula.id %}">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger">Desmarcar</button>
          </form>
        {% else %}
          <form method="post" action="{% url 'marcar_aula' aula.id %}">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-success">Marcar</button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>

  <hr>
  <h4>Deixe seu comentário</h4>
  <form method="post" action="{% url 'comentar_curso' curso.slug %}">
    {% csrf_token %}
    <div class="mb-3">
      {{ form_comentario.texto }}
    </div>
    <button type="submit" class="btn btn-primary">Enviar comentário</button>
  </form>

  <hr>
  <h4>Comentários</h4>
  {% if comentarios %}
    {% for comentario in comentarios %}
      <div class="card my-3">
        <div class="card-body">
          <strong>{{ comentario.usuario.username }}</strong>
          <span class="text-muted" style="font-size: 0.9em;">
            em {{ comentario.criado_em|date:"d/m/Y H:i" }}
          </span>
          <p>{{ comentario.texto }}</p>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>Este curso ainda não possui comentários.</p>
  {% endif %}
{% endif %}

<a href="/" class="btn btn-link mt-3">← Voltar para os cursos</a>
{% endblock %}

